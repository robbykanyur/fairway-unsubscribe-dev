{% extends 'base.html' %}

{% block content %}

{% if email %}
<span id="page-text">Are you sure you would like to unsubscribe {{ email }}?</span>
<form action="{{ url_for('unsubscribe') }}" method="post" novalidate>
  {{ form.hidden_tag() }}
  <p>{{ form.submit() }}</p>
</form>

{% else %}

No email address provided.

{% endif %}

<script>
  $(document).ready(function(){
    $('form').submit(function(e) {
      var url = "{{ url_for('unsubscribe') }}";
      $.ajax({
        type: "POST",
        url: url,
        data: $('form').serialize(),
        success: function(data) {
          $('#page-text').text('Success!');
          var email = data['email'];
          var previously = data['previously'];
          if(previously === true) {
            trumpet('[WARNING] Multiple unsubscribes for ' + email + '.');
          }
        },
        error: function(data) {
          email = data.responseJSON['email'];
          $('#page-text').text('Error!');
          trumpet('[500] Unsubscribe attempt failed for ' + email + '.');
        }
      });
      e.preventDefault();
    });

    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
          xhr.setRequestHeader("X-CSRFToken", "{{ form.csrf_token._value() }}")
        }
      }
    })
  });

  function trumpet(source_text) {
    var url = "{{ url_for('trumpeter') }}";
    var text = JSON.stringify(source_text);
    $.ajax({
      type: "POST",
      url: url,
      data: text,
      contentType: "application/json",
      dataType: 'json'
    });
  };
</script>

{% endblock %}
