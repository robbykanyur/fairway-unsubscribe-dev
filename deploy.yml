---
- hosts: unsubscribe
  remote_user: admin

  tasks:
    - name: pull from git
      git:
        repo: git@github.com:robertkanyur/fairway-unsubscribe-dev.git
        dest: /home/admin/unsubscribe
        update: yes
        version: master
    - name: rebuild unsubscribe-web image if necessary
      docker_image:
        path: /home/admin/unsubscribe
        tag: unsubscribe-web
    - name: rebuild unsubscribe-assets image if necessary
      docker_image:
        path: /home/admin/unsubscribe/assets
        tag: unsubscribe-assets
    - name: start building assets
      docker_service:
        project_src: /home/admin/unsubscribe/assets
      register: output
    - name: wait for assets to build
      wait_for:
        port: 2992
        state: stopped
    - name: docker containers down
      docker_service:
          project_src: /home/admin/unsubscribe
          state: absent
    - name: docker containers up
      docker_service:
          project_src: /home/admin/unsubscribe
          state: present
    - name: check web server is responding
      wait_for:
        port: 5000

